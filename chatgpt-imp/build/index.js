import b from"expiry-map";import{v4 as T}from"uuid";import h from"node-fetch";import{createParser as v}from"eventsource-parser";async function l(p,r){let{onMessage:e,...s}=r,t=await h(p,s),o=v(n=>{n.type==="event"&&e(n.data)});t.body.on("readable",()=>{let n;for(;(n=t.body.read())!==null;)o.feed(n.toString())})}import{remark as x}from"remark";import E from"strip-markdown";function _(p){return x().use(E).processSync(p??"").toString()}var w="accessToken",M="Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/107.0.0.0 Safari/537.36",y=class{constructor(r){this._accessTokenCache=new b(10*1e3);let{sessionToken:e,markdown:s=!0,apiBaseUrl:t="https://chat.openai.com/api",backendApiBaseUrl:o="https://chat.openai.com/backend-api",userAgent:n=M}=r;if(this._sessionToken=e,this._markdown=!!s,this._apiBaseUrl=t,this._backendApiBaseUrl=o,this._userAgent=n,!this._sessionToken)throw new Error("ChatGPT invalid session token")}async getIsAuthenticated(){try{return await this.refreshAccessToken(),!0}catch{return!1}}async ensureAuth(){return await this.refreshAccessToken()}async sendMessage(r,e={}){let{conversationId:s,parentMessageId:t=T(),onProgress:o}=e,n=await this.refreshAccessToken();var d={action:"next",messages:[{id:T(),role:"user",content:{content_type:"text",parts:[r]}}],model:"text-davinci-002-render"};s&&(d.conversation_id=s),t&&(d.parent_message_id=t);let A=`${this._backendApiBaseUrl}/conversation`,f={};return new Promise((S,g)=>{l(A,{method:"POST",headers:{Authorization:`Bearer ${n}`,"Content-Type":"application/json","user-agent":this._userAgent},body:JSON.stringify(d),onMessage:m=>{var k,u;if(m==="[DONE]")return S(JSON.stringify(f));try{let i=JSON.parse(m),a=i.message;if(a){let c=(u=(k=a==null?void 0:a.content)==null?void 0:k.parts)==null?void 0:u[0];c&&(this._markdown||(c=_(c)),f={answer:c,conversationId:i.conversation_id,id:a.id},o&&o(c))}}catch(i){console.warn("fetchSSE onMessage unexpected error",i),g(i)}}}).catch(g)})}async refreshAccessToken(){let r=this._accessTokenCache.get(w);if(r)return r;try{let e=await h("https://chat.openai.com/api/auth/session",{headers:{cookie:`__Secure-next-auth.session-token=${this._sessionToken}`,"user-agent":this._userAgent}}).then(o=>o.json()),s=e==null?void 0:e.accessToken;if(!s)throw new Error("Unauthorized");let t=e==null?void 0:e.error;if(t)throw t==="RefreshAccessTokenError"?new Error("session token has expired"):new Error(t);return this._accessTokenCache.set(w,s),s}catch(e){throw new Error(`ChatGPT failed to refresh auth token. ${e.toString()}`)}}};export{y as ChatGPTAPI,_ as markdownToText};
//# sourceMappingURL=index.js.map